#!/bin/bash

set -x

pushd /tmp/src || exit 1

INSTALL_URL=${INSTALL_URL:-$IMPORT_URL}

if [[ -n "${IMPORT_URL}" ]]; then

  popd || exit 1

  echo "Assembling GOPATH"

  GOPATH=$(realpath "${HOME}/go")
  export GOPATH

  mkdir -p "$GOPATH/src/$IMPORT_URL"

  mv /tmp/src/* "$GOPATH/src/$IMPORT_URL"

  if [[ -d /tmp/artifacts/pkg ]]; then

    echo "Restoring previous build artifacts"

    mv /tmp/artifacts/pkg "${GOPATH}"

  fi

  # Resolve dependencies, ignore if vendor present

  if [[ ! -d $GOPATH/src/$IMPORT_URL/vendor ]]; then

    echo "Resolving dependencies"

    pushd "${GOPATH}/src/${INSTALL_URL}" || exit 1

    go get

    popd || exit 1

  fi

  # lets build

  pushd "${GOPATH}/src/${INSTALL_URL}" || exit 1

  echo "Building"

  go install -i "${INSTALL_URL}"

  mv "${GOPATH}/bin/*" /opt/app-root/gobinary

  popd || exit

  exit

fi

exec "/${STI_SCRIPTS_PATH}/usage"
